<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier - Vue Hebdomadaire</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dist/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/calendar.css') }}">
</head>
<body>
    <!-- Navigation -->
    {% include 'components/navigation.html' %}

    <div class="week-container">
        <!-- Week Header -->
        <div class="week-header">
            <div class="week-info">
                <h1 class="week-title">üìÖ Calendrier Hebdomadaire</h1>
                <p class="current-week">
                    {% if current_week_offset == 0 %}
                        Semaine courante
                    {% elif current_week_offset > 0 %}
                        Dans {{ current_week_offset }} semaine{{ 's' if current_week_offset > 1 else '' }}
                    {% else %}
                        Il y a {{ -current_week_offset }} semaine{{ 's' if current_week_offset < -1 else '' }}
                    {% endif %}
                </p>
            </div>
            
            <div class="week-navigation">
                <a href="{{ url_for('calendar', week=current_week_offset-1) }}" class="nav-btn nav-btn--previous">‚Üê Pr√©c√©dente</a>
                <a href="{{ url_for('calendar', week=0) }}" class="nav-btn nav-btn--current">Cette semaine</a>
                <a href="{{ url_for('calendar', week=current_week_offset+1) }}" class="nav-btn nav-btn--next">Suivante ‚Üí</a>
            </div>
        </div>
        
        <!-- Week Grid -->
        <div class="week-grid">
            {% for date_str in week_dates %}
                {% set day_info = week_schedule[date_str.strftime('%Y-%m-%d')] %}
                <div class="day-card {% if day_info.date == current_date %}day-card--today{% endif %}">
                    <div class="day-header">
                        <div class="day-name">{{ day_info.day_name }}</div>
                        <div class="day-date">{{ day_info.day_number }} {{ day_info.month_name }}</div>
                    </div>
                    
                    <div class="day-content">
                        {% if day_info.data %}
                            <!-- Event Type Badge -->
                            {% if day_info.data[4] == 'Holiday' %}
                                <div class="event-badge event-badge--holiday">üèñÔ∏è Cong√©</div>
                            {% elif day_info.data[4] == 'P√©dagogique' %}
                                <div class="event-badge event-badge--pedagogique">üìö P√©dagogique</div>
                            {% elif day_info.data[4] == 'Class Day' %}
                                <div class="event-badge event-badge--class">üìñ Cours - Jour {{ day_info.data[3] }}</div>
                            {% elif day_info.data[4] == 'Summer Break' %}
                                <div class="event-badge event-badge--holiday">‚òÄÔ∏è Vacances d'√©t√©</div>
                            {% endif %}
                            
                            <!-- Course Periods -->
                            {% if day_info.data[4] == 'Class Day' %}
                                {% if day_info.data[5] %}
                                    <div class="course-slot course-slot--p1 clickable-course" 
                                         data-date="{{ day_info.date.strftime('%Y-%m-%d') }}" 
                                         data-period="1" 
                                         data-course="{{ day_info.data[5] }}">
                                        <div class="course-period">P√©riode 1</div>
                                        <div class="course-name">{{ day_info.data[5] }}</div>
                                    </div>
                                {% endif %}
                                
                                {% if day_info.data[6] %}
                                    <div class="course-slot course-slot--p2 clickable-course" 
                                         data-date="{{ day_info.date.strftime('%Y-%m-%d') }}" 
                                         data-period="2" 
                                         data-course="{{ day_info.data[6] }}">
                                        <div class="course-period">P√©riode 2</div>
                                        <div class="course-name">{{ day_info.data[6] }}</div>
                                    </div>
                                {% endif %}
                                
                                {% if day_info.data[7] %}
                                    <div class="course-slot course-slot--p3 clickable-course" 
                                         data-date="{{ day_info.date.strftime('%Y-%m-%d') }}" 
                                         data-period="3" 
                                         data-course="{{ day_info.data[7] }}">
                                        <div class="course-period">P√©riode 3</div>
                                        <div class="course-name">{{ day_info.data[7] }}</div>
                                    </div>
                                {% endif %}
                                
                                {% if day_info.data[8] %}
                                    <div class="course-slot course-slot--p4 clickable-course" 
                                         data-date="{{ day_info.date.strftime('%Y-%m-%d') }}" 
                                         data-period="4" 
                                         data-course="{{ day_info.data[8] }}">
                                        <div class="course-period">P√©riode 4</div>
                                        <div class="course-name">{{ day_info.data[8] }}</div>
                                    </div>
                                {% endif %}
                                
                                {% if not (day_info.data[5] or day_info.data[6] or day_info.data[7] or day_info.data[8]) %}
                                    <div class="no-classes">Pas de cours</div>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <!-- Handle days without data (weekends, etc.) -->
                            {% if day_info.day_name in ['Saturday', 'Sunday'] or day_info.day_name in ['Samedi', 'Dimanche'] %}
                                <div class="event-badge event-badge--weekend">üè† Week-end</div>
                            {% else %}
                                <div class="no-classes">Jour libre</div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- JavaScript for enhanced interactions -->
    <script>
        // Add keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                window.location.href = "{{ url_for('calendar', week=current_week_offset-1) }}";
            } else if (e.key === 'ArrowRight') {
                window.location.href = "{{ url_for('calendar', week=current_week_offset+1) }}";
            } else if (e.key === 'Home') {
                window.location.href = "{{ url_for('calendar', week=0) }}";
            }
        });

        // Animation for day cards
        document.addEventListener('DOMContentLoaded', function() {
            const dayCards = document.querySelectorAll('.day-card');
            dayCards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 50);
            });
            
            // Handle course slot clicks
            const courseSlots = document.querySelectorAll('.clickable-course');
            courseSlots.forEach(slot => {
                slot.addEventListener('click', function() {
                    const date = this.dataset.date;
                    const period = this.dataset.period;
                    const course = this.dataset.course;
                    
                    // Show loading state
                    this.style.opacity = '0.7';
                    this.style.cursor = 'wait';
                    
                    // Check if a lesson exists for this date/period/course
                    fetch(`/api/lesson-for-slot?date=${date}&period=${period}&course=${encodeURIComponent(course)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.lesson_id) {
                                // Navigate to existing lesson
                                window.location.href = `/lesson/${data.lesson_id}`;
                            } else {
                                // Navigate to creation page with pre-filled data
                                const params = new URLSearchParams({
                                    date: date,
                                    period: period,
                                    course: course
                                });
                                window.location.href = `/lesson/create?${params.toString()}`;
                            }
                        })
                        .catch(error => {
                            console.error('Error checking lesson:', error);
                            // Fallback to creation page
                            const params = new URLSearchParams({
                                date: date,
                                period: period,
                                course: course
                            });
                            window.location.href = `/lesson/create?${params.toString()}`;
                        })
                        .finally(() => {
                            // Reset loading state
                            this.style.opacity = '1';
                            this.style.cursor = 'pointer';
                        });
                });
                
                // Add hover effect
                slot.style.cursor = 'pointer';
                slot.title = 'Cliquer pour voir ou cr√©er la le√ßon';
            });
        });
    </script>
</body>
</html>